<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server/access-control.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server/access-control.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Generated by CoffeeScript 1.9.0
var Access_Control, debug, errorHandler, log, utils,
  __slice = [].slice;

utils = require('../utils');

debug = require('debug')("mithink:security");

log = require('debug')('mithink:actions');

errorHandler = require('./error-handler');

Access_Control = function(Bus) {
  Bus.__access_control__ = {};

  /**
   * defines access control middleware for actions
   * @class Server.Model 
   * @function Server.Model#guard
   * @param {Object} opts - an Object of actions to protect, and how to protect them
   * @example
   * Thing.guard {
   *   connection: (socket)->
   *     return false unless socket.authenticated
   *     return true
   * }
   */
  Bus.guard = function(opts) {
    var action, check, _results;
    _results = [];
    for (action in opts) {
      check = opts[action];
      _results.push(Bus.__access_control__[utils.namespace(this.model._name, action)] = check);
    }
    return _results;
  };
  Bus.checkpoint = function() {
    return Bus.__access_control__[utils.namespace(this.model._name, this.action)] || utils.allowAll;
  };
  return Bus.__protect__ = function(action) {
    var ctx;
    ctx = this;
    return function() {
      var args, denyMessage, passed;
      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];
      passed = Bus.checkpoint.call(ctx)(ctx.socket);
      denyMessage = "unauthorized attempt to perform " + ctx.action + " on " + ctx.model._name + " table";
      if (passed.then) {
        return passed.then(function() {
          log(ctx.socket.id + " performing " + (ctx.action.toUpperCase()) + " on " + (ctx.model._name.toUpperCase()) + " -- params: " + (JSON.stringify(args)));
          return action.apply(ctx, args);
        })["catch"](function(err) {
          if (err == null) {
            err = {};
          }
          debug(err.message || denyMessage);
          return errorHandler.call(ctx, 401, args[0], {
            message: err.message || denyMessage
          });
        });
      }
      if (passed) {
        log(ctx.socket.id + " performing " + (ctx.action.toUpperCase()) + " on " + (ctx.model._name.toUpperCase()) + " -- params: " + (JSON.stringify(args)));
        return action.apply(ctx, args);
      }
      debug(denyMessage);
      return errorHandler.call(ctx, 401, args[0], {
        message: denyMessage
      });
    };
  };
};

module.exports = Access_Control;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Server.Model.html">Model</a></li></ul><h3>Namespaces</h3><ul><li><a href="Mithink.Server.html">Server</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Fri Sep 11 2015 14:35:54 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
